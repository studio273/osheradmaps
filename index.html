<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מפת סניפי אושר עד - הדמיה</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser (for Gemini output) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* טעינת פונט Rubik כגיבוי (Google Sans הוא פונט קנייני ולא זמין חופשית ברשת) */
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap');
        
        body {
            /* שימוש ב-Google Sans בעדיפות ראשונה, ו-Rubik כגיבוי */
            font-family: 'Google Sans', 'Rubik', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f3f4f6;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
            background-color: #f3f4f6; /* רקע למקרה שהטעינה איטית */
        }

        .sidebar {
            z-index: 2;
            transition: transform 0.3s ease-in-out;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
        }

        /* עיצוב גלילה מותאם אישית לרשימה */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* עיצוב הפופאפ במפה - סגנון כרטיס */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
            border: none;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 300px !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 10px;
            right: 10px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-size: 24px;
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 2px;
        }
        .leaflet-container a.leaflet-popup-close-button:hover {
            background: rgba(0,0,0,0.4);
            color: white;
        }

        /* כרטיס סניף ברשימה */
        .branch-card {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .branch-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #1a9bd2; /* צבע משני */
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #0d1f43; /* צבע ראשי */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .ai-response ul { list-style-type: disc; padding-right: 20px; margin-bottom: 10px; }
        .ai-response ol { list-style-type: decimal; padding-right: 20px; margin-bottom: 10px; }
        .ai-response h3, .ai-response h4 { font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #0d1f43; } /* צבע ראשי */
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- סרגל צד (רשימת סניפים) -->
    <div id="sidebar" class="sidebar bg-white w-full md:w-[400px] h-1/2 md:h-full flex flex-col absolute md:relative bottom-0 md:bottom-auto z-20">
        
        <!-- כותרת וחיפוש -->
        <div class="p-5 bg-gradient-to-br from-[#0d1f43] to-[#1a9bd2] text-white shadow-lg shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-black tracking-tight flex items-center gap-3">
                        <!-- הלוגו הראשי המעודכן -->
                        <img src="https://i.ibb.co/Mkkwg3Kb/Screenshot-2026-01-12-at-12-54-47.png" alt="לוגו אושר עד" class="h-12 w-auto rounded-lg shadow-md border border-white/10">
                        אושר עד
                    </h1>
                    <p class="text-blue-100 text-sm opacity-90 mr-1">איתור סניפים וניווט חכם</p>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-lg px-3 py-1 text-center">
                    <span class="block text-xl font-bold" id="count-badge">0</span>
                    <span class="text-[10px] uppercase tracking-wider">סניפים</span>
                </div>
            </div>
            
            <div class="relative group">
                <input type="text" id="search-input" placeholder="חפש לפי עיר, רחוב או אזור..." 
                    class="w-full pl-4 pr-11 py-3 rounded-xl text-[#0d1f43] placeholder-gray-500 bg-white/95 focus:bg-white focus:outline-none focus:ring-4 focus:ring-[#1a9bd2]/30 shadow-inner transition-all">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 group-focus-within:text-[#1a9bd2] transition-colors"></i>
            </div>

            <!-- כפתור עוזר חכם - צבע שלישי (אדום) -->
            <button onclick="openAIModal()" class="mt-4 w-full bg-[#cf242b] hover:bg-[#b01e25] text-white font-bold py-2.5 px-4 rounded-xl shadow-md flex items-center justify-center gap-2 transition-all transform active:scale-95 border border-red-700">
                <i class="fas fa-sparkles text-yellow-300"></i> העוזר החכם לקניות
            </button>
        </div>

        <!-- רשימת סניפים -->
        <div id="branches-list" class="flex-1 overflow-y-auto custom-scrollbar p-4 bg-gray-50 space-y-3">
            <!-- הסניפים יוזרקו לכאן דינמית -->
        </div>
    </div>

    <!-- אזור המפה -->
    <div class="flex-1 relative h-1/2 md:h-full z-10">
        <div id="map"></div>
        
        <!-- כפתור צף למובייל -->
        <button id="toggle-sidebar" class="md:hidden absolute top-4 right-4 z-[999] bg-white text-[#0d1f43] p-3 rounded-full shadow-xl border border-gray-100" onclick="toggleMobileSidebar()">
            <i class="fas fa-list-ul text-xl"></i>
        </button>
    </div>

    <!-- מודאל AI -->
    <div id="ai-modal" class="modal-overlay fixed inset-0 z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] animate-fade-in-up">
            <!-- כותרת המודאל -->
            <div class="bg-gradient-to-r from-[#0d1f43] to-[#1a9bd2] text-white p-5 rounded-t-2xl flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-3">
                    <span class="bg-white/20 p-2 rounded-lg"><i class="fas fa-robot"></i></span>
                    העוזר החכם
                </h2>
                <button onclick="closeAIModal()" class="hover:bg-white/20 rounded-full p-2 transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- תוכן המודאל -->
            <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
                <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                    ברוכים הבאים! אני כאן כדי לעזור לכם לייעל את הקנייה בסניף.
                    בחרו כיצד תרצו שאעזור:
                </p>

                <!-- בחירת מצב -->
                <div class="grid grid-cols-3 gap-2 mb-6">
                    <button onclick="setAIMode('list')" id="btn-mode-list" class="flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2">
                        <i class="fas fa-list-check text-xl mb-1"></i>
                        <span class="font-bold text-xs">סידור רשימה</span>
                    </button>
                    <button onclick="setAIMode('recipe')" id="btn-mode-recipe" class="flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2">
                        <i class="fas fa-hat-chef text-xl mb-1"></i>
                        <span class="font-bold text-xs">הצעת מתכון</span>
                    </button>
                    <button onclick="setAIMode('image')" id="btn-mode-image" class="flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2">
                        <i class="fas fa-image text-xl mb-1"></i>
                        <span class="font-bold text-xs">יצירת תמונה</span>
                    </button>
                </div>

                <!-- טופס קלט -->
                <div class="mb-6">
                    <label id="input-label" class="block text-sm font-bold text-[#0d1f43] mb-2">
                        הכנס את הפריטים כאן:
                    </label>
                    <div class="relative">
                        <textarea id="user-input" rows="3" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#1a9bd2] focus:border-transparent resize-none bg-gray-50 text-gray-800 shadow-inner" placeholder="..."></textarea>
                        <div class="absolute bottom-2 left-2 text-gray-400 text-xs">
                            <i class="fas fa-keyboard"></i>
                        </div>
                    </div>
                </div>

                <!-- אזור תשובה -->
                <div id="ai-result-area" class="hidden mb-4">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-blue-100">
                            <span class="text-xs font-bold text-[#0d1f43] uppercase tracking-wider flex items-center gap-1">
                                <i class="fas fa-sparkles text-[#cf242b]"></i> המלצה עבורך
                            </span>
                            <button onclick="copyToClipboard()" id="copy-btn" class="text-[#1a9bd2] hover:text-[#0d1f43] hover:bg-blue-100 p-1 rounded transition" title="העתק">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                        <div id="ai-output" class="text-sm text-gray-800 ai-response leading-relaxed overflow-hidden"></div>
                    </div>
                </div>

                <!-- הודעת שגיאה -->
                <div id="ai-error" class="hidden bg-red-50 text-[#cf242b] p-4 rounded-xl text-sm mb-4 border border-red-100 flex items-center gap-2">
                    <i class="fas fa-exclamation-circle text-lg"></i>
                    <span>אירעה שגיאה בעיבוד הבקשה. אנא נסו שוב.</span>
                </div>
            </div>

            <!-- כפתורים למטה -->
            <div class="p-5 border-t border-gray-100 bg-gray-50/50 rounded-b-2xl flex justify-between items-center">
                <button onclick="closeAIModal()" class="px-4 py-2 text-gray-500 hover:text-gray-800 font-medium text-sm transition-colors">סגור</button>
                <button onclick="generateAIResponse()" id="btn-generate" class="px-8 py-2.5 bg-[#1a9bd2] hover:bg-[#1580b0] text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all transform active:scale-95 flex items-center gap-2">
                    <span>בצע פעולה</span>
                    <div id="btn-loader" class="loader hidden" style="width: 18px; height: 18px; border-width: 2px; border-top-color: white; border-left-color: rgba(255,255,255,0.2);"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- נתונים: רשימת סניפי אושר עד (עם תמונות המחשה) ---
        const branches = [
            { city: "אשדוד", address: "רחוב בעלי מלאכה 4", area: "דרום", coords: [31.8123, 34.6648], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.3 },
            { city: "אשקלון", address: "צומת בת הדר", area: "דרום", coords: [31.6445, 34.5819], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.2 },
            { city: "באר שבע", address: "רחוב הקוצר 15", area: "דרום", coords: [31.2432, 34.8028], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.1 },
            { city: "בית שמש", address: "קניון נעימי, שד' הגליל 1", area: "ירושלים והסביבה", coords: [31.7554, 34.9921], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.5 },
            { city: "ביתר עילית", address: "מרכז מסחרי לב ההר", area: "ירושלים והסביבה", coords: [31.6982, 35.1089], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.0 },
            { 
                city: "בני ברק", 
                address: "רחוב הקישון 11, מול קניון איילון", 
                area: "מרכז", 
                coords: [32.0975, 34.8301], 
                hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", 
                rating: 4.6,
                extra: {
                    established: "דצמבר 2010",
                    size: "כ-6,000 מ\"ר",
                    parking: "יש צמודה",
                    carts: "350",
                    scanners: "350"
                }
            },
            { city: "ירושלים - גבעת שאול", address: "רחוב בית הדפוס 29", area: "ירושלים והסביבה", coords: [31.7912, 35.1925], hours: "24 שעות בימי חמישי", rating: 4.4 },
            { city: "ירושלים - שמגר", address: "רחוב שמגר 16", area: "ירושלים והסביבה", coords: [31.7954, 35.2102], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.3 },
            { city: "ירושלים - תלפיות", address: "רחוב פייר קניג 26", area: "ירושלים והסביבה", coords: [31.7511, 35.2144], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.2 },
            { city: "חדרה", address: "רחוב המסגר 22", area: "צפון", coords: [32.4416, 34.9142], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.1 },
            { city: "חיפה", address: "דרך בר יהודה 31", area: "צפון", coords: [32.7884, 35.0351], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.4 },
            { city: "כנות", address: "פארק תעשיות כנות", area: "מרכז/דרום", coords: [31.7876, 34.7571], hours: "א'-ג': 09:00-22:00, ד'-ה': 09:00-23:00", rating: 4.2 },
            { city: "לוד", address: "רחוב בת שבע 1", area: "מרכז", coords: [31.9542, 34.8875], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.0 },
            { city: "מגדל העמק", address: "רחוב האיצטדיון 9", area: "צפון", coords: [32.6775, 35.2441], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.1 },
            { city: "תל אביב", address: "רחוב ולטר מוזס 6", area: "מרכז", coords: [32.0718, 34.7933], hours: "א'-ג': 09:00-22:00, ד'-ה': 09:00-23:00", rating: 4.5 },
            { city: "פתח תקווה", address: "רחוב בן ציון גליס 30", area: "מרכז", coords: [32.1064, 34.9082], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.3 },
            { city: "ראשון לציון", address: "רחוב אצ'ל 24", area: "מרכז", coords: [31.9863, 34.7816], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.4 },
            { city: "כפר סבא", address: "דרך הים 9 (מתחם G)", area: "מרכז/שרון", coords: [32.1728, 34.9248], hours: "א'-ג': 09:00-22:00, ד'-ה': 09:00-23:00", rating: 4.5 },
            { city: "נתניה", address: "שדרות טום לנטוס 60", area: "שרון", coords: [32.2851, 34.8724], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.3 },
            { city: "קרית ביאליק", address: "שדרות חן 4", area: "צפון", coords: [32.8468, 35.0872], hours: "א'-ג': 10:00-23:00, ד'-ה': 10:00-00:00", rating: 4.2 }
        ];

        // הוספת תמונות
        branches.forEach((b, i) => {
             b.image = `https://i.ibb.co/Mkkwg3Kb/Screenshot-2026-01-12-at-12-54-47.png`;
        });

        // --- אתחול המפה ---
        // הגדרת גבולות המפה לישראל בלבד
        const southWest = L.latLng(29.0, 33.5);
        const northEast = L.latLng(33.7, 36.0);
        const israelBounds = L.latLngBounds(southWest, northEast);

        const map = L.map('map', {
            zoomControl: false,
            maxBounds: israelBounds,       // הגבלת הגרירה לגבולות אלו
            maxBoundsViscosity: 1.0,       // מונע גרירה מחוץ לגבולות לחלוטין (קשיח)
            minZoom: 7,                    // מונע זום-אאוט רחוק מדי
            zoomSnap: 0.5                  // מאפשר רמות זום עדינות יותר
        }).setView([31.5, 34.8], 8.5);     // מיקום התחלתי מותאם
        
        L.control.zoom({ position: 'topleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // --- הוספת מסכה להסתרת שאר העולם ---
        // פוליגון שמכסה את כל העולם, עם "חור" מלבני סביב ישראל
        const worldCoords = [
            [90, -180],
            [90, 180],
            [-90, 180],
            [-90, -180]
        ];
        
        // הגדרת ה"חור" (האזור הגלוי) - טיפה רחב יותר מהגבולות החוסמים כדי לא לחתוך ערים בקצה
        const israelHole = [
            [33.8, 33.0], // צפון מערב
            [33.8, 36.5], // צפון מזרח
            [29.0, 36.5], // דרום מזרח
            [29.0, 33.0]  // דרום מערב
        ];

        L.polygon([worldCoords, israelHole], {
            color: '#f3f4f6', // צבע המסגרת (כמו רקע האתר)
            fillColor: '#f3f4f6', // צבע המילוי
            fillOpacity: 1, // אטימות מלאה - מסתיר את המפה שמתחת
            stroke: false,
            interactive: false // כדי לא להפריע לגרירה
        }).addTo(map);

        // עדכון אייקון: גודל דגל סטנדרטי (לא ענק) אך עם לוגו שממלא את כל שטח הדגל
        const createCustomIcon = () => L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="position: relative; width: 50px; height: 50px; filter: drop-shadow(2px 4px 3px rgba(0,0,0,0.3));">
                    <!-- מוט הדגל -->
                    <div style="position: absolute; bottom: 0; left: 0; width: 4px; height: 100%; background-color: #1a9bd2; border-radius: 2px;"></div>
                    <!-- גוף הדגל -->
                    <div style="position: absolute; top: 2px; left: 3px; width: 47px; height: 34px; background-color: white; border: 1.5px solid #1a9bd2; border-left: none; border-radius: 0 4px 4px 0; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <!-- הלוגו ממלא את כל שטח הדגל (object-fit: cover וללא padding) -->
                        <img src="https://i.ibb.co/Mkkwg3Kb/Screenshot-2026-01-12-at-12-54-47.png" alt="אושר עד" style="width: 100%; height: 100%; object-fit: fill;">
                    </div>
                   </div>`,
            iconSize: [50, 50],
            iconAnchor: [2, 50], // עוגן בתחתית המוט
            popupAnchor: [25, -45]
        });

        // --- לוגיקה ---
        const listContainer = document.getElementById('branches-list');
        const countBadge = document.getElementById('count-badge');
        let markers = [];

        function renderBranches(filterText = "") {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            listContainer.innerHTML = "";

            const filteredBranches = branches.filter(branch => 
                branch.city.includes(filterText) || 
                branch.address.includes(filterText) ||
                branch.area.includes(filterText)
            );

            countBadge.innerText = filteredBranches.length;

            filteredBranches.forEach((branch) => {
                const marker = L.marker(branch.coords, { icon: createCustomIcon() }).addTo(map);
                
                // בניית HTML למידע נוסף אם קיים
                let extraInfoHtml = '';
                if (branch.extra) {
                    extraInfoHtml = `
                        <div class="mb-3 p-2 bg-blue-50 rounded border border-blue-100 text-xs text-gray-700 grid grid-cols-2 gap-y-1 gap-x-2">
                            ${branch.extra.established ? `<div><span class="font-bold text-[#0d1f43]">הקמה:</span> ${branch.extra.established}</div>` : ''}
                            ${branch.extra.size ? `<div><span class="font-bold text-[#0d1f43]">גודל:</span> ${branch.extra.size}</div>` : ''}
                            ${branch.extra.parking ? `<div><span class="font-bold text-[#0d1f43]">חניה:</span> ${branch.extra.parking}</div>` : ''}
                            ${branch.extra.carts ? `<div><span class="font-bold text-[#0d1f43]">עגלות:</span> ${branch.extra.carts}</div>` : ''}
                            ${branch.extra.scanners ? `<div class="col-span-2 border-t border-blue-100 pt-1 mt-1"><span class="font-bold text-[#0d1f43]">סורקים:</span> ${branch.extra.scanners}</div>` : ''}
                        </div>
                    `;
                }

                const popupContent = `
                    <div class="font-sans" dir="rtl">
                        <div class="h-32 bg-gray-200 bg-cover bg-center" style="background-image: url('${branch.image}')"></div>
                        <div class="p-4 bg-white">
                            <h3 class="font-bold text-xl text-[#0d1f43] mb-1">${branch.city}</h3>
                            <p class="text-sm text-gray-500 mb-3 flex items-center gap-1"><i class="fas fa-map-pin"></i> ${branch.address}</p>
                            
                            <div class="flex items-center gap-2 mb-3 text-xs text-gray-600 bg-gray-100 p-2 rounded">
                                <i class="far fa-clock text-[#1a9bd2]"></i>
                                <span>${branch.hours.substring(0, 25)}...</span>
                            </div>

                            ${extraInfoHtml}

                            <a href="https://waze.com/ul?q=${encodeURIComponent('אושר עד ' + branch.city + ' ' + branch.address)}" target="_blank" 
                               class="block w-full text-center bg-[#1a9bd2] hover:bg-[#1580b0] text-white font-bold py-2 rounded-lg transition-colors shadow-md text-sm">
                                <i class="fas fa-location-arrow ml-1"></i> נווט לסניף
                            </a>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);

                const card = document.createElement('div');
                card.className = "branch-card bg-white rounded-xl shadow-sm p-0 overflow-hidden cursor-pointer group";
                card.innerHTML = `
                    <div class="flex h-28">
                        <div class="w-1/3 bg-gray-200 bg-cover bg-center relative" style="background-image: url('${branch.image}')">
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                        </div>
                        <div class="w-2/3 p-3 flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-[#0d1f43] text-lg leading-tight group-hover:text-[#1a9bd2] transition">${branch.city}</h3>
                                    <div class="flex items-center bg-blue-50 px-1.5 py-0.5 rounded text-[#0d1f43] text-xs font-bold">
                                        <span>${branch.rating}</span> <i class="fas fa-star text-[#cf242b] text-[10px] ml-1"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 truncate"><i class="fas fa-map-marker-alt ml-1"></i> ${branch.address}</p>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full">${branch.area}</span>
                                <span class="text-xs text-[#1a9bd2] font-medium">לפרטים <i class="fas fa-arrow-left text-[10px]"></i></span>
                            </div>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    map.setView(branch.coords, 14);
                    marker.openPopup();
                    if (window.innerWidth < 768) {
                        toggleMobileSidebar();
                    }
                });

                listContainer.appendChild(card);
            });
        }

        function toggleMobileSidebar() {
            const sb = document.getElementById('sidebar');
            if (sb.classList.contains('hidden')) {
                sb.classList.remove('hidden');
                sb.classList.add('flex');
            } else {
                 if(window.innerWidth < 768) {
                     sb.classList.toggle('translate-y-full');
                 }
            }
        }
        
        document.getElementById('search-input').addEventListener('input', (e) => {
            renderBranches(e.target.value);
        });

        // AI Logic
        let currentMode = 'list';
        const apiKey = ""; 

        function openAIModal() {
            document.getElementById('ai-modal').classList.remove('hidden');
            if(!document.getElementById('ai-output').innerText) setAIMode('list');
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function setAIMode(mode) {
            currentMode = mode;
            const btnList = document.getElementById('btn-mode-list');
            const btnRecipe = document.getElementById('btn-mode-recipe');
            const btnImage = document.getElementById('btn-mode-image');
            const inputLabel = document.getElementById('input-label');
            const userInput = document.getElementById('user-input');
            const copyBtn = document.getElementById('copy-btn');
            
            // עדכון צבעים: מסגרת תכלת, רקע כחול בהיר, טקסט כחול כהה
            const activeClass = "border-[#1a9bd2] bg-[#e6f4fa] text-[#0d1f43] ring-1 ring-[#1a9bd2]";
            const inactiveClass = "border-gray-200 bg-white text-gray-500 hover:bg-gray-50";

            // Reset all
            btnList.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${inactiveClass}`;
            btnRecipe.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${inactiveClass}`;
            btnImage.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${inactiveClass}`;
            
            if (mode === 'list') {
                btnList.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${activeClass}`;
                inputLabel.innerText = "הדבק כאן את רשימת הקניות שלך:";
                userInput.placeholder = "חלב, לחם, עגבניות, שמפו, בשר טחון...";
                copyBtn.classList.remove('hidden');
            } else if (mode === 'recipe') {
                btnRecipe.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${activeClass}`;
                inputLabel.innerText = "מה יש לך במקרר/במזווה?";
                userInput.placeholder = "יש לי פסטה, עגבניות וקצת גבינה צהובה...";
                copyBtn.classList.remove('hidden');
            } else if (mode === 'image') {
                btnImage.className = `flex flex-col items-center justify-center py-4 px-1 rounded-xl border-2 transition-all gap-2 ${activeClass}`;
                inputLabel.innerText = "תאר את התמונה שתרצה ליצור:";
                userInput.placeholder = "עוגת שוקולד עשירה עם קצפת, סלסלת פירות טרופיים...";
                copyBtn.classList.add('hidden');
            }
        }

        async function generateAIResponse() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) return;

            const btn = document.getElementById('btn-generate');
            const loader = document.getElementById('btn-loader');
            const resultArea = document.getElementById('ai-result-area');
            const errorArea = document.getElementById('ai-error');
            const output = document.getElementById('ai-output');

            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            loader.classList.remove('hidden');
            resultArea.classList.add('hidden');
            errorArea.classList.add('hidden');
            output.innerHTML = ""; // Clear previous

            try {
                if (currentMode === 'image') {
                    // Image Generation
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: userInput }],
                            parameters: { sampleCount: 1 }
                        })
                    });

                    if (!response.ok) throw new Error('Image API Error');

                    const data = await response.json();
                    // Extract base64
                    const base64 = data.predictions?.[0]?.bytesBase64Encoded;
                    if (!base64) throw new Error('No image data returned');

                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${base64}`;
                    img.className = "w-full rounded-lg shadow-md";
                    img.alt = "Generated Image";
                    
                    output.appendChild(img);
                    
                } else {
                    // Text Generation
                    let systemInstruction = "";
                    let prompt = "";

                    if (currentMode === 'list') {
                        systemInstruction = "You are a helpful assistant for a shopper at 'Osher Ad'. Organize the list by supermarket aisles. Output in Hebrew using Markdown.";
                        prompt = `Organize this shopping list: ${userInput}`;
                    } else {
                        systemInstruction = "You are a helpful Israeli chef. Suggest a kosher recipe. Output in Hebrew using Markdown.";
                        prompt = `Suggest a recipe using these ingredients: ${userInput}`;
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    });

                    if (!response.ok) throw new Error('Text API Error');

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "לא הצלחתי לייצר תשובה.";
                    output.innerHTML = marked.parse(aiText);
                }

                resultArea.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                errorArea.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                loader.classList.add('hidden');
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('ai-output').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[title="העתק"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => btn.innerHTML = originalHTML, 2000);
            });
        }

        renderBranches();
    </script>
</body>
</html>
